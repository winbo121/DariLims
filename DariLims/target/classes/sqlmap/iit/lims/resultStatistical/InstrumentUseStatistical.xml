<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="InstrumentUseStatistical">
	
	<!-- 장비활용조회 (월별) -->
	<select id="selectInstrumentUseMList" parameterType="InstrumentUseStatisticalVO" resultType="InstrumentUseStatisticalVO">
		SELECT
			I.INST_NO
			,INST_KOR_NM
			,INST_ENG_NM
			,(SELECT USER_NM FROM USER_INFO WHERE MNG_ID = USER_ID) AS MNG_NM
			,(SELECT USER_NM FROM USER_INFO WHERE MNG_SUB_ID = USER_ID) AS MNG_SUB_NM
			,MANAGE_FLAG
			,NTIS_NO
			,TO_CHAR(TO_DATE(INSTL_DATE),'YY.MM.DD') AS INSTL_DATE
			,NVL(M01,0) AS M01,NVL(M02,0) AS M02,NVL(M03,0) AS M03,NVL(M04,0) AS M04,NVL(M05,0) AS M05,NVL(M06,0) AS M06
			,NVL(M07,0) AS M07,NVL(M08,0) AS M08,NVL(M09,0) AS M09,NVL(M10,0) AS M10,NVL(M11,0) AS M11,NVL(M12,0) AS M12
			,8*20 AS TOT_USE_TIME
			,NVL(MANAGE_TIME,0) AS MANAGE_TIME
			,NVL(TRUNC(MANAGE_TIME / (8*20) * 100, 1),0) AS MANAGE_RATE
			FROM INSTRUMENT I
			LEFT OUTER JOIN (SELECT * FROM (SELECT MNG_ID, MNG_SUB_ID, INST_NO FROM INST_MNG_HIS ORDER BY MNG_NO DESC) WHERE ROWNUM = 1) IMH ON I.INST_NO = IMH.INST_NO
			LEFT OUTER JOIN
			(SELECT 
			INST_NO
			,SUM(CASE WHEN SUBSTR(TO_CHAR(USE_SDATE,'YYYYMM'),5,2) = '01' THEN USE_TIME END) AS M01
			,SUM(CASE WHEN SUBSTR(TO_CHAR(USE_SDATE,'YYYYMM'),5,2) = '02' THEN USE_TIME END) AS M02
			,SUM(CASE WHEN SUBSTR(TO_CHAR(USE_SDATE,'YYYYMM'),5,2) = '03' THEN USE_TIME END) AS M03
			,SUM(CASE WHEN SUBSTR(TO_CHAR(USE_SDATE,'YYYYMM'),5,2) = '04' THEN USE_TIME END) AS M04
			,SUM(CASE WHEN SUBSTR(TO_CHAR(USE_SDATE,'YYYYMM'),5,2) = '05' THEN USE_TIME END) AS M05
			,SUM(CASE WHEN SUBSTR(TO_CHAR(USE_SDATE,'YYYYMM'),5,2) = '06' THEN USE_TIME END) AS M06
			,SUM(CASE WHEN SUBSTR(TO_CHAR(USE_SDATE,'YYYYMM'),5,2) = '07' THEN USE_TIME END) AS M07
			,SUM(CASE WHEN SUBSTR(TO_CHAR(USE_SDATE,'YYYYMM'),5,2) = '08' THEN USE_TIME END) AS M08
			,SUM(CASE WHEN SUBSTR(TO_CHAR(USE_SDATE,'YYYYMM'),5,2) = '09' THEN USE_TIME END) AS M09
			,SUM(CASE WHEN SUBSTR(TO_CHAR(USE_SDATE,'YYYYMM'),5,2) = '10' THEN USE_TIME END) AS M10
			,SUM(CASE WHEN SUBSTR(TO_CHAR(USE_SDATE,'YYYYMM'),5,2) = '11' THEN USE_TIME END) AS M11
			,SUM(CASE WHEN SUBSTR(TO_CHAR(USE_SDATE,'YYYYMM'),5,2) = '12' THEN USE_TIME END) AS M12  
			,SUM(USE_TIME) AS MANAGE_TIME
			FROM INST_USE_HIS
			GROUP BY INST_NO
			) IUH ON I.INST_NO = IUH.INST_NO
			ORDER BY I.INST_NO
	</select>
	
	<!-- 장비활용조회 (분기별) -->
	<select id="selectInstrumentUseQList" parameterType="InstrumentUseStatisticalVO" resultType="InstrumentUseStatisticalVO">
		SELECT
			I.INST_NO
			,INST_KOR_NM
			,INST_ENG_NM
			,(SELECT USER_NM FROM USER_INFO WHERE MNG_ID = USER_ID) AS MNG_NM
			,(SELECT USER_NM FROM USER_INFO WHERE MNG_SUB_ID = USER_ID) AS MNG_SUB_NM
			,MANAGE_FLAG
			,NTIS_NO
			,TO_CHAR(TO_DATE(INSTL_DATE),'YY.MM.DD') AS INSTL_DATE
			,NVL(Q01,0) AS Q01,NVL(Q02,0) AS Q02,NVL(Q03,0) AS Q03,NVL(Q04,0) AS Q04
			,8*20 AS TOT_USE_TIME
			,NVL(MANAGE_TIME,0) AS MANAGE_TIME
			,NVL(TRUNC(MANAGE_TIME / (8*20) * 100, 1),0) AS MANAGE_RATE
			FROM INSTRUMENT I
			LEFT OUTER JOIN (SELECT * FROM (SELECT MNG_ID, MNG_SUB_ID, INST_NO FROM INST_MNG_HIS ORDER BY MNG_NO DESC) WHERE ROWNUM = 1) IMH ON I.INST_NO = IMH.INST_NO
			LEFT OUTER JOIN
			(SELECT 
			INST_NO
			,SUM(CASE 
			        WHEN SUBSTR(TO_CHAR(USE_SDATE,'YYYYMM'),5,2) = '01' OR 
			             SUBSTR(TO_CHAR(USE_SDATE,'YYYYMM'),5,2) = '02' OR
			             SUBSTR(TO_CHAR(USE_SDATE,'YYYYMM'),5,2) = '03' THEN USE_TIME      
			        END
			    ) AS Q01
			,SUM(CASE 
			        WHEN SUBSTR(TO_CHAR(USE_SDATE,'YYYYMM'),5,2) = '04' OR 
			             SUBSTR(TO_CHAR(USE_SDATE,'YYYYMM'),5,2) = '05' OR
			             SUBSTR(TO_CHAR(USE_SDATE,'YYYYMM'),5,2) = '06' THEN USE_TIME      
			        END
			    ) AS Q02
			,SUM(CASE 
			        WHEN SUBSTR(TO_CHAR(USE_SDATE,'YYYYMM'),5,2) = '07' OR 
			             SUBSTR(TO_CHAR(USE_SDATE,'YYYYMM'),5,2) = '08' OR
			             SUBSTR(TO_CHAR(USE_SDATE,'YYYYMM'),5,2) = '09' THEN USE_TIME      
			        END
			    ) AS Q03
			,SUM(CASE 
			        WHEN SUBSTR(TO_CHAR(USE_SDATE,'YYYYMM'),5,2) = '10' OR 
			             SUBSTR(TO_CHAR(USE_SDATE,'YYYYMM'),5,2) = '11' OR
			             SUBSTR(TO_CHAR(USE_SDATE,'YYYYMM'),5,2) = '12' THEN USE_TIME      
			        END
			    ) AS Q04  
			,SUM(USE_TIME) AS MANAGE_TIME
			FROM INST_USE_HIS
			GROUP BY INST_NO
			) IUH ON I.INST_NO = IUH.INST_NO
			ORDER BY I.INST_NO
			
					
	</select>

</mapper>